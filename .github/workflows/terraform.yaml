---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: "Terraform"

on:
  workflow_dispatch:
  pull_request:
    branches:
      - "main"
    paths:
      - "infrastructure/terraform/**"
  push:
    branches:
      - "main"
    paths:
      - "infrastructure/terraform/**"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.ref }}
  cancel-in-progress: true

jobs:
  changed-terraform:
    name: Changed Terraform
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Get changed files
        id: changed-files
        uses: bjw-s-labs/action-changed-files@b1144fc772fca235a50902c7bb6cc431cc7d8e27 # v0.3.2
        with:
          include_only_directories: true
          patterns: |
            infrastructure/terraform/**

      - name: List all changed files
        run: |
          echo '${{ steps.changed-files.outputs.changed_files }}'

      - name: Store changed projects
        id: set-matrix
        run: |
          CHANGED=${{ steps.changed-files.outputs.changed_files }}

          if [ "$CHANGED" = "[]" ]; then
            echo "No projects changed, defaulting to all projects."
            PROJECTS=$(find infrastructure/terraform -mindepth 1 -maxdepth 1 -type d | jq -R -s -c 'split("\n") | map(select(length > 0))')
          else
            PROJECTS=$(echo "$CHANGED" | jq -R -s -c 'split(" ") | map(select(length > 0))')
          fi

          echo "matrix={\"project\":$PROJECTS}" >> "${GITHUB_OUTPUT}"
  diff:
    name: Terraform Diff
    runs-on:
      - garb-arc-runner-set
    needs:
      - changed-terraform
    strategy:
      matrix: ${{ fromJSON(needs.changed-terraform.outputs.matrix) }}
      max-parallel: 4
      fail-fast: false
    steps:
      - name: Get Secrets
        uses: larivierec/sm-action@main
        with:
          access_token: ${{ secrets.BW_ACCESS_TOKEN }}
          parse_json: "true"
          secrets: |
            4c93fe22-dd57-4d4d-96b2-b20600132b47
            3d25a5f7-3eb7-49c3-a376-b20400d833bd

      - name: Extract Secret Values
        id: parse-secrets
        run: |
          echo "bot_app_id=$BOT_ID" >> "$GITHUB_OUTPUT"
          echo "bot_app_private_key=$BOT_PK_B64" >> "$GITHUB_OUTPUT"
          echo "cloud_token=$CLOUD_TOKEN" >> "$GITHUB_OUTPUT"

      - name: Decode Private Key Securely
        id: decode
        run: |
          private_key=$(echo "${{ steps.parse-secrets.outputs.bot_app_private_key }}" | base64 -d | awk 'BEGIN {ORS="\\n"} {print}' | head -c -2) &> /dev/null
          echo "::add-mask::$private_key"
          echo "private-key=$private_key" >> "$GITHUB_OUTPUT"

      - name: Generate Token
        uses: actions/create-github-app-token@3ff1caaa28b64c9cc276ce0a02e2ff584f3900c5 # v2
        id: app-token
        with:
          app-id: ${{ steps.parse-secrets.outputs.bot_app_id }}
          private-key: ${{ steps.decode.outputs.private-key }}

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          token: ${{ steps.app-token.outputs.token }}

      - uses: hashicorp/setup-terraform@v3
        with:
          cli_config_credentials_token: ${{ steps.parse-secrets.outputs.cloud_token }}

      - name: terraform init
        id: init
        working-directory: ${{ matrix.paths }}
        run: terraform init

      - name: terraform fmt
        id: fmt
        working-directory: ${{ matrix.paths }}
        run: terraform fmt -check
        continue-on-error: true

      - name: terraform validate
        id: validate
        working-directory: ${{ matrix.paths }}
        run: terraform validate -no-color

      - name: terraform plan
        working-directory: ${{ matrix.paths }}
        run: terraform plan -no-color -out .planfile

      - name: Post PR comment
        continue-on-error: true
        uses: borchero/terraform-plan-comment@3399d8dbae8b05185e815e02361ede2949cd99c4 # v2.4.0
        with:
          token: ${{ steps.app-token.outputs.token }}
          planfile: .planfile
          terraform-cmd: terraform
          header: "ðŸ“ Terraform Plan for ${{ matrix.paths }}"
          working-directory: ${{ matrix.paths }}

      - name: upload planfile
        uses: actions/upload-artifact@v4
        with:
          name: plan
          include-hidden-files: true
          path: ${{ matrix.paths }}/.planfile

  apply:
    if: github.event_name != 'pull_request'
    runs-on:
      - garb-arc-runner-set
    needs:
      - changed-terraform
      - diff
    strategy:
      matrix: ${{ fromJSON(needs.changed-terraform.outputs.matrix) }}
      max-parallel: 4
      fail-fast: false
    steps:
      - name: download planfile
        uses: actions/download-artifact@v4
        with:
          name: plan
          path: ${{ matrix.paths }}

      - name: Get Secrets
        uses: larivierec/sm-action@main
        with:
          access_token: ${{ secrets.BW_ACCESS_TOKEN }}
          parse_json: "true"
          secrets: |
            4c93fe22-dd57-4d4d-96b2-b20600132b47
            3d25a5f7-3eb7-49c3-a376-b20400d833bd

      - name: Extract Secret Values
        id: parse-secrets
        run: |
          echo "bot_app_id=$BOT_ID" >> "$GITHUB_OUTPUT"
          echo "bot_app_private_key=$BOT_PK_B64" >> "$GITHUB_OUTPUT"
          echo "cloud_token=$CLOUD_TOKEN" >> "$GITHUB_OUTPUT"

      - name: Decode Private Key Securely
        id: decode
        run: |
          private_key=$(echo "${{ steps.parse-secrets.outputs.bot_app_private_key }}" | base64 -d | awk 'BEGIN {ORS="\\n"} {print}' | head -c -2) &> /dev/null
          echo "::add-mask::$private_key"
          echo "private-key=$private_key" >> "$GITHUB_OUTPUT"

      - name: Generate Token
        uses: actions/create-github-app-token@3ff1caaa28b64c9cc276ce0a02e2ff584f3900c5 # v2
        id: app-token
        with:
          app-id: ${{ steps.parse-secrets.outputs.bot_app_id }}
          private-key: ${{ steps.decode.outputs.private-key }}

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          token: ${{ steps.app-token.outputs.token }}

      - uses: hashicorp/setup-terraform@v3
        with:
          cli_config_credentials_token: ${{ steps.parse-secrets.outputs.cloud_token }}

      - name: terraform init
        id: init
        working-directory: ${{ matrix.paths }}
        run: terraform init

      - name: terraform apply
        working-directory: ${{ matrix.paths }}
        run: terraform apply -no-color .planfile
