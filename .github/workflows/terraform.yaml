---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: "Terraform"

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
    paths:
      - .github/workflows/terraform*
      - infrastructure/terraform/**
  push:
    branches:
      - main
    paths:
      - .github/workflows/terraform*
      - infrastructure/terraform/**

concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.ref }}
  cancel-in-progress: true

jobs:
  changed-terraform:
    name: Changed Terraform
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Get changed files
        id: changed-files
        uses: bjw-s-labs/action-changed-files@015416e33c709af88f84a4496f4030c1f0ef212e # v0.5.0
        with:
          include_only_directories: true
          patterns: |
            infrastructure/terraform/**

      - name: List all changed files
        run: |
          echo '${{ steps.changed-files.outputs.changed_files }}'

      - name: Store changed projects
        id: set-matrix
        run: |
          CHANGED=$(echo '${{ steps.changed-files.outputs.changed_files }}')

          if [ "$CHANGED" = "[]" ]; then
            echo "No projects changed, defaulting to all projects."
            PROJECTS=$(find infrastructure/terraform -mindepth 1 -maxdepth 1 -type d | jq -R -s -c 'split("\n") | map(select(length > 0))')
          else
            PROJECTS=$(echo "$CHANGED" | jq -c '.')
          fi

          echo "matrix={\"paths\":"$PROJECTS"}" >> "${GITHUB_OUTPUT}"
  diff:
    name: Terraform Plan
    runs-on:
      - garb-arc-runner-set
    needs:
      - changed-terraform
    strategy:
      matrix: ${{ fromJSON(needs.changed-terraform.outputs.matrix) }}
      max-parallel: 4
      fail-fast: false
    steps:
      - name: Strip project path
        id: strip-path
        run: |
          project_path=$(echo "${{ matrix.paths }}" | sed 's/^\[//; s/\]$//')
          safe_name=$(echo "$project_path" | tr '/' '-')
          echo "Project path stripped: $project_path"
          echo "project_path=$project_path" >> "$GITHUB_OUTPUT"
          echo "safe_name=$safe_name" >> "$GITHUB_OUTPUT"

      - name: Load 1Password Secrets
        uses: 1password/load-secrets-action/configure@8d0d610af187e78a2772c2d18d627f4c52d3fbfb # v3.1.0
        with:
          connect-host: https://op.garb.dev
          connect-token: ${{ secrets.OP_CONNECT_TOKEN }}

      - name: Load secrets
        uses: 1password/load-secrets-action@8d0d610af187e78a2772c2d18d627f4c52d3fbfb # v3.1.0
        with: { export-env: true }
        env:
          BOT_ID: op://Homelab/github/bot_id
          BOT_PK_B64: op://Homelab/github/bot_pk_b64
          KEY: op://Homelab/age/key
          AWS_ACCESS_KEY_ID: op://Homelab/minio/user
          AWS_SECRET_ACCESS_KEY: op://Homelab/minio/password

      - name: Extract Secret Values
        id: parse-secrets
        run: |
          echo "bot_app_id=$BOT_ID" >> "$GITHUB_OUTPUT"
          echo "bot_app_private_key=$BOT_PK_B64" >> "$GITHUB_OUTPUT"
          echo "age_b64=$KEY" >> "$GITHUB_OUTPUT"

      - name: Decode Base64 Securely
        id: decode
        run: |
          private_key=$(echo "${{ steps.parse-secrets.outputs.bot_app_private_key }}" | base64 -d | awk 'BEGIN {ORS="\\n"} {print}' | head -c -2) &> /dev/null
          echo "::add-mask::$private_key"
          echo "private-key=$private_key" >> "$GITHUB_OUTPUT"

          age=$(echo "${{ steps.parse-secrets.outputs.age_b64 }}" | base64 -d | grep '^AGE-SECRET-KEY-')
          echo "::add-mask::$age"
          echo "masked-age=$age" >> "$GITHUB_OUTPUT"

      - name: Create age keys.txt
        run: |
          mkdir -p "$HOME/.config/sops/age"
          echo "${{ steps.decode.outputs.masked-age }}" > "$HOME/.config/sops/age/keys.txt"

      - name: Generate Token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2
        id: app-token
        with:
          app-id: ${{ steps.parse-secrets.outputs.bot_app_id }}
          private-key: ${{ steps.decode.outputs.private-key }}

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          token: ${{ steps.app-token.outputs.token }}

      - name: Install node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: 20

      - uses: hashicorp/setup-terraform@5e8dbf3c6d9deaf4193ca7a8fb23f2ac83bb6c85 # v4

      - name: terraform init
        id: init
        working-directory: ${{ steps.strip-path.outputs.project_path }}
        run: terraform init

      - name: terraform fmt
        id: fmt
        working-directory: ${{ steps.strip-path.outputs.project_path }}
        run: terraform fmt -check
        continue-on-error: true

      - name: terraform validate
        id: validate
        working-directory: ${{ steps.strip-path.outputs.project_path }}
        run: terraform validate -no-color

      - name: terraform plan
        working-directory: ${{ steps.strip-path.outputs.project_path }}
        run: terraform plan -no-color -out .planfile

      - name: Post PR comment
        if: github.event_name == 'pull_request'
        continue-on-error: true
        uses: borchero/terraform-plan-comment@9c18ac901b5d2b58e9cbd9d1480af36e28ffaf88 # v2.6.1
        with:
          token: ${{ steps.app-token.outputs.token }}
          planfile: .planfile
          terraform-cmd: terraform
          header: "ðŸ“ Terraform Plan for ${{ matrix.paths }}"
          working-directory: ${{ steps.strip-path.outputs.project_path }}

      - name: upload planfile
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: plan-${{ steps.strip-path.outputs.safe_name }}
          include-hidden-files: true
          path: ${{ steps.strip-path.outputs.project_path }}/.planfile

      - name: Ensure deletion
        if: always()
        run: |
          rm $HOME/.config/sops/age/keys.txt

  apply:
    name: Terraform Apply
    if: github.event_name != 'pull_request'
    runs-on:
      - garb-arc-runner-set
    needs:
      - changed-terraform
      - diff
    strategy:
      matrix: ${{ fromJSON(needs.changed-terraform.outputs.matrix) }}
      max-parallel: 4
      fail-fast: false
    steps:
      - name: Load 1Password Secrets
        uses: 1password/load-secrets-action/configure@8d0d610af187e78a2772c2d18d627f4c52d3fbfb # v3.1.0
        with:
          connect-host: https://op.garb.dev
          connect-token: ${{ secrets.OP_CONNECT_TOKEN }}

      - name: Load secrets
        uses: 1password/load-secrets-action@8d0d610af187e78a2772c2d18d627f4c52d3fbfb # v3.1.0
        with: { export-env: true }
        env:
          BOT_ID: op://Homelab/github/bot_id
          BOT_PK_B64: op://Homelab/github/bot_pk_b64
          KEY: op://Homelab/age/key
          AWS_ACCESS_KEY_ID: op://Homelab/minio/user
          AWS_SECRET_ACCESS_KEY: op://Homelab/minio/password

      - name: Extract Secret Values
        id: parse-secrets
        run: |
          echo "bot_app_id=$BOT_ID" >> "$GITHUB_OUTPUT"
          echo "bot_app_private_key=$BOT_PK_B64" >> "$GITHUB_OUTPUT"
          echo "age_b64=$KEY" >> "$GITHUB_OUTPUT"

      - name: Decode Private Key Securely
        id: decode
        run: |
          private_key=$(echo "${{ steps.parse-secrets.outputs.bot_app_private_key }}" | base64 -d | awk 'BEGIN {ORS="\\n"} {print}' | head -c -2) &> /dev/null
          echo "::add-mask::$private_key"
          echo "private-key=$private_key" >> "$GITHUB_OUTPUT"

          age=$(echo "${{ steps.parse-secrets.outputs.age_b64 }}" | base64 -d | grep '^AGE-SECRET-KEY-')
          echo "::add-mask::$age"
          echo "masked-age=$age" >> "$GITHUB_OUTPUT"

      - name: Create age keys.txt
        run: |
          mkdir -p "$HOME/.config/sops/age"
          echo "${{ steps.decode.outputs.masked-age }}" > "$HOME/.config/sops/age/keys.txt"

      - name: Generate Token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2
        id: app-token
        with:
          app-id: ${{ steps.parse-secrets.outputs.bot_app_id }}
          private-key: ${{ steps.decode.outputs.private-key }}

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          token: ${{ steps.app-token.outputs.token }}

      - name: Strip project path
        id: strip-path
        run: |
          project_path=$(echo "${{ matrix.paths }}" | sed 's/^\[//; s/\]$//')
          safe_name=$(echo "$project_path" | tr '/' '-')
          echo "Project path stripped: $project_path"
          echo "project_path=$project_path" >> "$GITHUB_OUTPUT"
          echo "safe_name=$safe_name" >> "$GITHUB_OUTPUT"

      - name: download planfile
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: plan-${{ steps.strip-path.outputs.safe_name }}
          path: ${{ steps.strip-path.outputs.project_path }}

      - name: Install node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: 20

      - uses: hashicorp/setup-terraform@5e8dbf3c6d9deaf4193ca7a8fb23f2ac83bb6c85 # v4

      - name: terraform init
        id: init
        working-directory: ${{ steps.strip-path.outputs.project_path }}
        run: terraform init

      - name: terraform apply
        working-directory: ${{ steps.strip-path.outputs.project_path }}
        run: terraform apply -no-color .planfile

      - name: Ensure deletion
        if: always()
        run: |
          rm $HOME/.config/sops/age/keys.txt
